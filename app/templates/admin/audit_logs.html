{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="logs-page">
        <div class="page-header">
            <h2>ðŸ”’ Audit Logs</h2>
            <p class="page-subtitle">Security and administrative action history</p>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon">ðŸ“Š</div>
                <div class="stat-value">{{ stats.total_logs }}</div>
                <div class="stat-label">Total Audit Logs</div>
            </div>
            
            {% if stats.by_action %}
            {% for action_stat in stats.by_action[:3] %}
            <div class="stat-card">
                <div class="stat-icon">ðŸ”‘</div>
                <div class="stat-value">{{ action_stat.count }}</div>
                <div class="stat-label">{{ action_stat.action.replace('_', ' ').title() }}</div>
            </div>
            {% endfor %}
            {% endif %}
        </div>

        <div class="filters-section">
            <form method="get" class="filters-form">
                <div class="filter-group">
                    <label for="action">Filter by Action:</label>
                    <select name="action" id="action" class="filter-select">
                        <option value="">All Actions</option>
                        {% for action in unique_actions %}
                        <option value="{{ action }}" {% if current_action == action %}selected{% endif %}>
                            {{ action.replace('_', ' ').title() }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="limit">Show:</label>
                    <select name="limit" id="limit" class="filter-select">
                        <option value="50" {% if limit == 50 %}selected{% endif %}>50 logs</option>
                        <option value="100" {% if limit == 100 %}selected{% endif %}>100 logs</option>
                        <option value="200" {% if limit == 200 %}selected{% endif %}>200 logs</option>
                        <option value="500" {% if limit == 500 %}selected{% endif %}>500 logs</option>
                    </select>
                </div>
                
                <button type="submit" class="filter-btn">Apply Filters</button>
                <a href="/admincp/audit-logs" class="filter-btn filter-btn-reset">Clear Filters</a>
            </form>
        </div>

        {% if logs %}
        <div class="logs-container">
            <div class="logs-table-wrapper">
                <table class="logs-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>Actor</th>
                            <th>Target</th>
                            <th>Details</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr class="log-row">
                            <td class="timestamp-cell">
                                <span class="date">{{ log.timestamp[:10] if log.timestamp else 'N/A' }}</span>
                                <span class="time">{{ log.timestamp[11:19] if log.timestamp and log.timestamp|length > 19 else '' }}</span>
                            </td>
                            <td class="action-cell">
                                <span class="badge badge-action badge-{{ log.action.split('_')[0] }}">
                                    {{ log.action.replace('_', ' ').title() }}
                                </span>
                            </td>
                            <td class="user-cell">
                                <span class="user-icon">ðŸ‘¤</span>
                                <strong>{{ log.actor_username or 'Unknown' }}</strong>
                            </td>
                            <td class="user-cell">
                                {% if log.target_username %}
                                <span class="user-icon">ðŸŽ¯</span>
                                <strong>{{ log.target_username }}</strong>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td class="details-cell">
                                {% if log.details %}
                                <button class="details-btn" onclick="showDetails('{{ log._key }}')">View Details</button>
                                <div id="details-{{ log._key }}" class="details-content" style="display: none;">
                                    <pre>{{ log.details | tojson(indent=2) }}</pre>
                                </div>
                                {% else %}
                                <span class="text-muted">No details</span>
                                {% endif %}
                            </td>
                            <td class="ip-cell">{{ log.ip_address or 'unknown' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ðŸ”’</div>
            <p>No audit logs found</p>
            <p class="empty-hint">Audit logs will appear here when security-related actions occur</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function showDetails(logKey) {
    const detailsDiv = document.getElementById(`details-${logKey}`);
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
    } else {
        detailsDiv.style.display = 'none';
    }
}
</script>

<style>
.logs-page {
    max-width: 1400px;
    margin: 40px auto;
    padding: 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-header h2 {
    color: #fff;
    font-size: 36px;
    margin-bottom: 10px;
}

.page-subtitle {
    color: #999;
    font-size: 18px;
}

.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: #2a2a2a;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}

.stat-icon {
    font-size: 32px;
    margin-bottom: 10px;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 5px;
}

.stat-label {
    color: #999;
    font-size: 14px;
}

.filters-section {
    background: #2a2a2a;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}

.filters-form {
    display: flex;
    gap: 15px;
    align-items: flex-end;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.filter-group label {
    color: #ccc;
    font-size: 14px;
    font-weight: 600;
}

.filter-select {
    padding: 10px 15px;
    background: #1a1a1a;
    border: 1px solid #444;
    border-radius: 6px;
    color: #fff;
    font-size: 14px;
    min-width: 200px;
}

.filter-select:focus {
    outline: none;
    border-color: #4c9ee0;
}

.filter-btn {
    padding: 10px 20px;
    background: linear-gradient(135deg, #5a9fd4, #4a7fb4);
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s;
}

.filter-btn:hover {
    transform: translateY(-2px);
}

.filter-btn-reset {
    background: #444;
}

.filter-btn-reset:hover {
    background: #555;
}

.logs-container {
    background: #2a2a2a;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    overflow-x: auto;
}

.logs-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1000px;
}

.logs-table thead tr {
    border-bottom: 2px solid #444;
}

.logs-table th {
    padding: 15px 10px;
    text-align: left;
    color: #ccc;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
}

.logs-table tbody tr {
    border-bottom: 1px solid #333;
    transition: background 0.2s;
}

.logs-table tbody tr:hover {
    background: #333;
}

.logs-table td {
    padding: 15px 10px;
    color: #ddd;
    font-size: 14px;
}

.timestamp-cell {
    min-width: 120px;
}

.timestamp-cell .date {
    display: block;
    color: #fff;
    font-weight: 600;
}

.timestamp-cell .time {
    display: block;
    color: #999;
    font-size: 12px;
}

.action-cell {
    min-width: 180px;
}

.badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.badge-action {
    background: #6c5ce7;
    color: #fff;
}

.badge-password {
    background: #ff8c00;
    color: #fff;
}

.badge-role {
    background: #51cf66;
    color: #000;
}

.user-cell {
    min-width: 150px;
}

.user-icon {
    margin-right: 5px;
}

.details-cell {
    min-width: 120px;
}

.details-btn {
    padding: 5px 10px;
    background: #4c9ee0;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.details-btn:hover {
    background: #3a8ed1;
}

.details-content {
    margin-top: 10px;
    padding: 10px;
    background: #1a1a1a;
    border-radius: 4px;
    max-width: 400px;
}

.details-content pre {
    margin: 0;
    color: #51cf66;
    font-size: 11px;
    overflow-x: auto;
}

.ip-cell {
    color: #999;
    font-family: monospace;
    font-size: 12px;
}

.text-muted {
    color: #666;
    font-style: italic;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
}

.empty-icon {
    font-size: 64px;
    margin-bottom: 20px;
}

.empty-state p {
    font-size: 18px;
    margin-bottom: 10px;
}

.empty-hint {
    font-size: 14px;
    color: #666;
}
</style>
{% endblock %}
